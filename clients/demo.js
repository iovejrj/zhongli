// Generated by CoffeeScript 1.3.3

$(function() {
  var draw_item, error_handler, last, sayit, topics, view, warning;
  window.socket = io.connect('127.0.0.1:8000/chat');
  warning = void 0;
  error_handler = function(data) {
    if (warning != null) {
      clearTimeout(warning);
    }
    return (function() {
      $('#warning').text(data.info);
      $('.alert').slideDown();
      return warning = setTimeout((function() {
        return ($('.alert')).slideUp();
      }), 1000);
    })();
  };
  socket.on('has-error', error_handler);
  if (localStorage.name != null) {
    socket.emit('set-name', {
      name: localStorage.name.trim()
    });
    $('#name').val(localStorage.name.trim());
  }
  $('#name').bind('input', function() {
    socket.emit('set-name', {
      name: $('#name').val().trim()
    });
    return localStorage.name = $('#name').val().trim();
  });
  view = 'home';
  last = '';
  $('#say').bind('input', function() {
    if (view !== 'home') {
      return socket.emit('sync-post', {
        head: $('#say').val()
      });
    }
  });
  sayit = function(e) {
    if ($('#say').val().trim().length === 0) {
      error_handler({
        info: 'cant send black'
      });
    }
    if (view === 'home') {
      socket.emit('add-topic', {
        text: $('#say').val().trim()
      });
    } else {
      socket.emit('add-post', {
        text: $('#say').val().trim()
      });
    }
    return $('#say').val('');
  };
  $('#say').keydown(function(e) {
    if (e.keyCode === 13) {
      return sayit();
    }
  });
  $('#send').click(function() {
    return sayit();
  });
  draw_item = function(item) {
    $('<li/>').attr('id', item.mark).attr('class', 'item').appendTo($('#list'));
    $('#' + item.mark).html("      <span class='time'>" + item.date + " " + item.time + "</span>      <span class='name'>" + item.name + "</span><br>      <span class='text'>" + item.text + "</span>");
    return $('#' + item.mark).click(function() {
      console.log(item.mark);
      $('#topic').text(item.text);
      last = '';
      return $('#say').val('');
    });
  };
  topics = [];
  socket.on('add-topic', function(item) {
    draw_item(item);
    return topics.push(item);
  });
  if (localStorage.name != null) {
    $('#say').focus();
  } else {
    $('#name').focus();
  }
  socket.emit('topic-list');
  socket.on('topic-list', function(list) {
    topics = list.reverse();
    return topics.forEach(draw_item);
  });
  return $('#home').click(function() {
    $('#list').html('');
    topics.forEach(draw_item);
    last = '';
    $('#say').val('');
    return $('#topic').text('');
  });
});
